"use strict";
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImFwcC5qcyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSIsImZpbGUiOiJwYXJ0cy9pbWFnZS1nYWxsZXJ5Lm1pbi5qcyIsInNvdXJjZXNDb250ZW50IjpbIid1c2Ugc3RyaWN0JztcclxuXHJcbi8qISBtZWRpdW0tem9vbSAxLjAuNCB8IE1JVCBMaWNlbnNlIHwgaHR0cHM6Ly9naXRodWIuY29tL2ZyYW5jb2lzY2hhbGlmb3VyL21lZGl1bS16b29tICovXHJcbihmdW5jdGlvbihnbG9iYWwsIGZhY3RvcnkpIHtcclxuICAgIHR5cGVvZiBleHBvcnRzID09PSBcIm9iamVjdFwiICYmIHR5cGVvZiBtb2R1bGUgIT09IFwidW5kZWZpbmVkXCIgPyBtb2R1bGUuZXhwb3J0cyA9IGZhY3RvcnkoKSA6IHR5cGVvZiBkZWZpbmUgPT09IFwiZnVuY3Rpb25cIiAmJiBkZWZpbmUuYW1kID8gZGVmaW5lKGZhY3RvcnkpIDogd2luZG93Lm1lZGl1bVpvb20gPSBmYWN0b3J5KCk7XHJcbiAgfSkodGhpcywgZnVuY3Rpb24oKSB7XHJcbiAgICBcInVzZSBzdHJpY3RcIjtcclxuICAgIHZhciBfZXh0ZW5kcyA9IE9iamVjdC5hc3NpZ24gfHwgZnVuY3Rpb24odGFyZ2V0KSB7XHJcbiAgICAgIGZvciAodmFyIGkgPSAxOyBpIDwgYXJndW1lbnRzLmxlbmd0aDsgaSsrKSB7XHJcbiAgICAgICAgdmFyIHNvdXJjZSA9IGFyZ3VtZW50c1tpXTtcclxuICAgICAgICBmb3IgKHZhciBrZXkgaW4gc291cmNlKSB7XHJcbiAgICAgICAgICBpZiAoT2JqZWN0LnByb3RvdHlwZS5oYXNPd25Qcm9wZXJ0eS5jYWxsKHNvdXJjZSwga2V5KSkge1xyXG4gICAgICAgICAgICB0YXJnZXRba2V5XSA9IHNvdXJjZVtrZXldO1xyXG4gICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgICAgfVxyXG4gICAgICByZXR1cm4gdGFyZ2V0O1xyXG4gICAgfTtcclxuICAgIHZhciBpc1N1cHBvcnRlZCA9IGZ1bmN0aW9uIGlzU3VwcG9ydGVkKG5vZGUpIHtcclxuICAgICAgcmV0dXJuIG5vZGUudGFnTmFtZSA9PT0gXCJJTUdcIjtcclxuICAgIH07XHJcbiAgICB2YXIgaXNOb2RlTGlzdCA9IGZ1bmN0aW9uIGlzTm9kZUxpc3Qoc2VsZWN0b3IpIHtcclxuICAgICAgcmV0dXJuIE5vZGVMaXN0LnByb3RvdHlwZS5pc1Byb3RvdHlwZU9mKHNlbGVjdG9yKTtcclxuICAgIH07XHJcbiAgICB2YXIgaXNOb2RlID0gZnVuY3Rpb24gaXNOb2RlKHNlbGVjdG9yKSB7XHJcbiAgICAgIHJldHVybiBzZWxlY3RvciAmJiBzZWxlY3Rvci5ub2RlVHlwZSA9PT0gMTtcclxuICAgIH07XHJcbiAgICB2YXIgaXNTdmcgPSBmdW5jdGlvbiBpc1N2ZyhpbWFnZSkge1xyXG4gICAgICB2YXIgc291cmNlID0gaW1hZ2UuY3VycmVudFNyYyB8fCBpbWFnZS5zcmM7XHJcbiAgICAgIHJldHVybiBzb3VyY2Uuc3Vic3RyKC00KS50b0xvd2VyQ2FzZSgpID09PSBcIi5zdmdcIjtcclxuICAgIH07XHJcbiAgICB2YXIgZ2V0SW1hZ2VzRnJvbVNlbGVjdG9yID0gZnVuY3Rpb24gZ2V0SW1hZ2VzRnJvbVNlbGVjdG9yKHNlbGVjdG9yKSB7XHJcbiAgICAgIHRyeSB7XHJcbiAgICAgICAgaWYgKEFycmF5LmlzQXJyYXkoc2VsZWN0b3IpKSB7XHJcbiAgICAgICAgICByZXR1cm4gc2VsZWN0b3IuZmlsdGVyKGlzU3VwcG9ydGVkKTtcclxuICAgICAgICB9XHJcbiAgICAgICAgaWYgKGlzTm9kZUxpc3Qoc2VsZWN0b3IpKSB7XHJcbiAgICAgICAgICByZXR1cm4gW10uc2xpY2UuY2FsbChzZWxlY3RvcikuZmlsdGVyKGlzU3VwcG9ydGVkKTtcclxuICAgICAgICB9XHJcbiAgICAgICAgaWYgKGlzTm9kZShzZWxlY3RvcikpIHtcclxuICAgICAgICAgIHJldHVybiBbIHNlbGVjdG9yIF0uZmlsdGVyKGlzU3VwcG9ydGVkKTtcclxuICAgICAgICB9XHJcbiAgICAgICAgaWYgKHR5cGVvZiBzZWxlY3RvciA9PT0gXCJzdHJpbmdcIikge1xyXG4gICAgICAgICAgcmV0dXJuIFtdLnNsaWNlLmNhbGwoZG9jdW1lbnQucXVlcnlTZWxlY3RvckFsbChzZWxlY3RvcikpLmZpbHRlcihpc1N1cHBvcnRlZCk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHJldHVybiBbXTtcclxuICAgICAgfSBjYXRjaCAoZXJyKSB7XHJcbiAgICAgICAgdGhyb3cgbmV3IFR5cGVFcnJvcihcIlRoZSBwcm92aWRlZCBzZWxlY3RvciBpcyBpbnZhbGlkLlxcblwiICsgXCJFeHBlY3RzIGEgQ1NTIHNlbGVjdG9yLCBhIE5vZGUgZWxlbWVudCwgYSBOb2RlTGlzdCBvciBhbiBhcnJheS5cXG5cIiArIFwiU2VlOiBodHRwczovL2dpdGh1Yi5jb20vZnJhbmNvaXNjaGFsaWZvdXIvbWVkaXVtLXpvb21cIik7XHJcbiAgICAgIH1cclxuICAgIH07XHJcbiAgICB2YXIgY3JlYXRlT3ZlcmxheSA9IGZ1bmN0aW9uIGNyZWF0ZU92ZXJsYXkoYmFja2dyb3VuZCkge1xyXG4gICAgICB2YXIgb3ZlcmxheSA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoXCJkaXZcIik7XHJcbiAgICAgIG92ZXJsYXkuY2xhc3NMaXN0LmFkZChcIm1lZGl1bS16b29tLW92ZXJsYXlcIik7XHJcbiAgICAgIG92ZXJsYXkuc3R5bGUuYmFja2dyb3VuZCA9IGJhY2tncm91bmQ7XHJcbiAgICAgIHJldHVybiBvdmVybGF5O1xyXG4gICAgfTtcclxuICAgIHZhciBjbG9uZVRhcmdldCA9IGZ1bmN0aW9uIGNsb25lVGFyZ2V0KHRlbXBsYXRlKSB7XHJcbiAgICAgIHZhciBfdGVtcGxhdGUkZ2V0Qm91bmRpbmcgPSB0ZW1wbGF0ZS5nZXRCb3VuZGluZ0NsaWVudFJlY3QoKSwgdG9wID0gX3RlbXBsYXRlJGdldEJvdW5kaW5nLnRvcCwgbGVmdCA9IF90ZW1wbGF0ZSRnZXRCb3VuZGluZy5sZWZ0LCB3aWR0aCA9IF90ZW1wbGF0ZSRnZXRCb3VuZGluZy53aWR0aCwgaGVpZ2h0ID0gX3RlbXBsYXRlJGdldEJvdW5kaW5nLmhlaWdodDtcclxuICAgICAgdmFyIGNsb25lID0gdGVtcGxhdGUuY2xvbmVOb2RlKCk7XHJcbiAgICAgIHZhciBzY3JvbGxUb3AgPSB3aW5kb3cucGFnZVlPZmZzZXQgfHwgZG9jdW1lbnQuZG9jdW1lbnRFbGVtZW50LnNjcm9sbFRvcCB8fCBkb2N1bWVudC5ib2R5LnNjcm9sbFRvcCB8fCAwO1xyXG4gICAgICB2YXIgc2Nyb2xsTGVmdCA9IHdpbmRvdy5wYWdlWE9mZnNldCB8fCBkb2N1bWVudC5kb2N1bWVudEVsZW1lbnQuc2Nyb2xsTGVmdCB8fCBkb2N1bWVudC5ib2R5LnNjcm9sbExlZnQgfHwgMDtcclxuICAgICAgY2xvbmUucmVtb3ZlQXR0cmlidXRlKFwiaWRcIik7XHJcbiAgICAgIGNsb25lLnN0eWxlLnBvc2l0aW9uID0gXCJhYnNvbHV0ZVwiO1xyXG4gICAgICBjbG9uZS5zdHlsZS50b3AgPSB0b3AgKyBzY3JvbGxUb3AgKyBcInB4XCI7XHJcbiAgICAgIGNsb25lLnN0eWxlLmxlZnQgPSBsZWZ0ICsgc2Nyb2xsTGVmdCArIFwicHhcIjtcclxuICAgICAgY2xvbmUuc3R5bGUud2lkdGggPSB3aWR0aCArIFwicHhcIjtcclxuICAgICAgY2xvbmUuc3R5bGUuaGVpZ2h0ID0gaGVpZ2h0ICsgXCJweFwiO1xyXG4gICAgICBjbG9uZS5zdHlsZS50cmFuc2Zvcm0gPSBcIlwiO1xyXG4gICAgICByZXR1cm4gY2xvbmU7XHJcbiAgICB9O1xyXG4gICAgdmFyIGNyZWF0ZUN1c3RvbUV2ZW50ID0gZnVuY3Rpb24gY3JlYXRlQ3VzdG9tRXZlbnQodHlwZSwgcGFyYW1zKSB7XHJcbiAgICAgIHZhciBldmVudFBhcmFtcyA9IF9leHRlbmRzKHtcclxuICAgICAgICBidWJibGVzOiBmYWxzZSxcclxuICAgICAgICBjYW5jZWxhYmxlOiBmYWxzZSxcclxuICAgICAgICBkZXRhaWw6IHVuZGVmaW5lZFxyXG4gICAgICB9LCBwYXJhbXMpO1xyXG4gICAgICBpZiAodHlwZW9mIHdpbmRvdy5DdXN0b21FdmVudCA9PT0gXCJmdW5jdGlvblwiKSB7XHJcbiAgICAgICAgcmV0dXJuIG5ldyBDdXN0b21FdmVudCh0eXBlLCBldmVudFBhcmFtcyk7XHJcbiAgICAgIH1cclxuICAgICAgdmFyIGN1c3RvbUV2ZW50ID0gZG9jdW1lbnQuY3JlYXRlRXZlbnQoXCJDdXN0b21FdmVudFwiKTtcclxuICAgICAgY3VzdG9tRXZlbnQuaW5pdEN1c3RvbUV2ZW50KHR5cGUsIGV2ZW50UGFyYW1zLmJ1YmJsZXMsIGV2ZW50UGFyYW1zLmNhbmNlbGFibGUsIGV2ZW50UGFyYW1zLmRldGFpbCk7XHJcbiAgICAgIHJldHVybiBjdXN0b21FdmVudDtcclxuICAgIH07XHJcbiAgICB2YXIgbWVkaXVtWm9vbSA9IGZ1bmN0aW9uIG1lZGl1bVpvb20oc2VsZWN0b3IpIHtcclxuICAgICAgdmFyIG9wdGlvbnMgPSBhcmd1bWVudHMubGVuZ3RoID4gMSAmJiBhcmd1bWVudHNbMV0gIT09IHVuZGVmaW5lZCA/IGFyZ3VtZW50c1sxXSA6IHt9O1xyXG4gICAgICB2YXIgUHJvbWlzZSA9IHdpbmRvdy5Qcm9taXNlIHx8IGZ1bmN0aW9uIFByb21pc2UoZm4pIHtcclxuICAgICAgICBmdW5jdGlvbiBub29wKCkge31cclxuICAgICAgICBmbihub29wLCBub29wKTtcclxuICAgICAgfTtcclxuICAgICAgdmFyIF9oYW5kbGVDbGljayA9IGZ1bmN0aW9uIF9oYW5kbGVDbGljayhldmVudCkge1xyXG4gICAgICAgIHZhciB0YXJnZXQgPSBldmVudC50YXJnZXQ7XHJcbiAgICAgICAgaWYgKHRhcmdldCA9PT0gb3ZlcmxheSkge1xyXG4gICAgICAgICAgY2xvc2UoKTtcclxuICAgICAgICAgIHJldHVybjtcclxuICAgICAgICB9XHJcbiAgICAgICAgaWYgKGltYWdlcy5pbmRleE9mKHRhcmdldCkgPT09IC0xKSB7XHJcbiAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHRvZ2dsZSh7XHJcbiAgICAgICAgICB0YXJnZXQ6IHRhcmdldFxyXG4gICAgICAgIH0pO1xyXG4gICAgICB9O1xyXG4gICAgICB2YXIgX2hhbmRsZVNjcm9sbCA9IGZ1bmN0aW9uIF9oYW5kbGVTY3JvbGwoKSB7XHJcbiAgICAgICAgaWYgKGlzQW5pbWF0aW5nIHx8ICFhY3RpdmUub3JpZ2luYWwpIHtcclxuICAgICAgICAgIHJldHVybjtcclxuICAgICAgICB9XHJcbiAgICAgICAgdmFyIGN1cnJlbnRTY3JvbGwgPSB3aW5kb3cucGFnZVlPZmZzZXQgfHwgZG9jdW1lbnQuZG9jdW1lbnRFbGVtZW50LnNjcm9sbFRvcCB8fCBkb2N1bWVudC5ib2R5LnNjcm9sbFRvcCB8fCAwO1xyXG4gICAgICAgIGlmIChNYXRoLmFicyhzY3JvbGxUb3AgLSBjdXJyZW50U2Nyb2xsKSA+IHpvb21PcHRpb25zLnNjcm9sbE9mZnNldCkge1xyXG4gICAgICAgICAgc2V0VGltZW91dChjbG9zZSwgMTUwKTtcclxuICAgICAgICB9XHJcbiAgICAgIH07XHJcbiAgICAgIHZhciBfaGFuZGxlS2V5VXAgPSBmdW5jdGlvbiBfaGFuZGxlS2V5VXAoZXZlbnQpIHtcclxuICAgICAgICBpZiAoKGV2ZW50LmtleUNvZGUgfHwgZXZlbnQud2hpY2gpID09PSAyNykge1xyXG4gICAgICAgICAgY2xvc2UoKTtcclxuICAgICAgICB9XHJcbiAgICAgIH07XHJcbiAgICAgIHZhciB1cGRhdGUgPSBmdW5jdGlvbiB1cGRhdGUoKSB7XHJcbiAgICAgICAgdmFyIG9wdGlvbnMgPSBhcmd1bWVudHMubGVuZ3RoID4gMCAmJiBhcmd1bWVudHNbMF0gIT09IHVuZGVmaW5lZCA/IGFyZ3VtZW50c1swXSA6IHt9O1xyXG4gICAgICAgIHZhciBuZXdPcHRpb25zID0gb3B0aW9ucztcclxuICAgICAgICBpZiAob3B0aW9ucy5iYWNrZ3JvdW5kKSB7XHJcbiAgICAgICAgICBvdmVybGF5LnN0eWxlLmJhY2tncm91bmQgPSBvcHRpb25zLmJhY2tncm91bmQ7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGlmIChvcHRpb25zLmNvbnRhaW5lciAmJiBvcHRpb25zLmNvbnRhaW5lciBpbnN0YW5jZW9mIE9iamVjdCkge1xyXG4gICAgICAgICAgbmV3T3B0aW9ucy5jb250YWluZXIgPSBfZXh0ZW5kcyh7fSwgem9vbU9wdGlvbnMuY29udGFpbmVyLCBvcHRpb25zLmNvbnRhaW5lcik7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGlmIChvcHRpb25zLnRlbXBsYXRlKSB7XHJcbiAgICAgICAgICB2YXIgdGVtcGxhdGUgPSBpc05vZGUob3B0aW9ucy50ZW1wbGF0ZSkgPyBvcHRpb25zLnRlbXBsYXRlIDogZG9jdW1lbnQucXVlcnlTZWxlY3RvcihvcHRpb25zLnRlbXBsYXRlKTtcclxuICAgICAgICAgIG5ld09wdGlvbnMudGVtcGxhdGUgPSB0ZW1wbGF0ZTtcclxuICAgICAgICB9XHJcbiAgICAgICAgem9vbU9wdGlvbnMgPSBfZXh0ZW5kcyh7fSwgem9vbU9wdGlvbnMsIG5ld09wdGlvbnMpO1xyXG4gICAgICAgIGltYWdlcy5mb3JFYWNoKGZ1bmN0aW9uKGltYWdlKSB7XHJcbiAgICAgICAgICBpbWFnZS5kaXNwYXRjaEV2ZW50KGNyZWF0ZUN1c3RvbUV2ZW50KFwibWVkaXVtLXpvb206dXBkYXRlXCIsIHtcclxuICAgICAgICAgICAgZGV0YWlsOiB7XHJcbiAgICAgICAgICAgICAgem9vbTogem9vbVxyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICB9KSk7XHJcbiAgICAgICAgfSk7XHJcbiAgICAgICAgcmV0dXJuIHpvb207XHJcbiAgICAgIH07XHJcbiAgICAgIHZhciBjbG9uZSA9IGZ1bmN0aW9uIGNsb25lKCkge1xyXG4gICAgICAgIHZhciBvcHRpb25zID0gYXJndW1lbnRzLmxlbmd0aCA+IDAgJiYgYXJndW1lbnRzWzBdICE9PSB1bmRlZmluZWQgPyBhcmd1bWVudHNbMF0gOiB7fTtcclxuICAgICAgICByZXR1cm4gbWVkaXVtWm9vbShfZXh0ZW5kcyh7fSwgem9vbU9wdGlvbnMsIG9wdGlvbnMpKTtcclxuICAgICAgfTtcclxuICAgICAgdmFyIGF0dGFjaCA9IGZ1bmN0aW9uIGF0dGFjaCgpIHtcclxuICAgICAgICBmb3IgKHZhciBfbGVuID0gYXJndW1lbnRzLmxlbmd0aCwgc2VsZWN0b3JzID0gQXJyYXkoX2xlbiksIF9rZXkgPSAwOyBfa2V5IDwgX2xlbjsgX2tleSsrKSB7XHJcbiAgICAgICAgICBzZWxlY3RvcnNbX2tleV0gPSBhcmd1bWVudHNbX2tleV07XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHZhciBuZXdJbWFnZXMgPSBzZWxlY3RvcnMucmVkdWNlKGZ1bmN0aW9uKGltYWdlc0FjY3VtdWxhdG9yLCBjdXJyZW50U2VsZWN0b3IpIHtcclxuICAgICAgICAgIHJldHVybiBbXS5jb25jYXQoaW1hZ2VzQWNjdW11bGF0b3IsIGdldEltYWdlc0Zyb21TZWxlY3RvcihjdXJyZW50U2VsZWN0b3IpKTtcclxuICAgICAgICB9LCBbXSk7XHJcbiAgICAgICAgbmV3SW1hZ2VzLmZpbHRlcihmdW5jdGlvbihuZXdJbWFnZSkge1xyXG4gICAgICAgICAgcmV0dXJuIGltYWdlcy5pbmRleE9mKG5ld0ltYWdlKSA9PT0gLTE7XHJcbiAgICAgICAgfSkuZm9yRWFjaChmdW5jdGlvbihuZXdJbWFnZSkge1xyXG4gICAgICAgICAgaW1hZ2VzLnB1c2gobmV3SW1hZ2UpO1xyXG4gICAgICAgICAgbmV3SW1hZ2UuY2xhc3NMaXN0LmFkZChcIm1lZGl1bS16b29tLWltYWdlXCIpO1xyXG4gICAgICAgIH0pO1xyXG4gICAgICAgIGV2ZW50TGlzdGVuZXJzLmZvckVhY2goZnVuY3Rpb24oX3JlZikge1xyXG4gICAgICAgICAgdmFyIHR5cGUgPSBfcmVmLnR5cGUsIGxpc3RlbmVyID0gX3JlZi5saXN0ZW5lciwgb3B0aW9ucyA9IF9yZWYub3B0aW9ucztcclxuICAgICAgICAgIG5ld0ltYWdlcy5mb3JFYWNoKGZ1bmN0aW9uKGltYWdlKSB7XHJcbiAgICAgICAgICAgIGltYWdlLmFkZEV2ZW50TGlzdGVuZXIodHlwZSwgbGlzdGVuZXIsIG9wdGlvbnMpO1xyXG4gICAgICAgICAgfSk7XHJcbiAgICAgICAgfSk7XHJcbiAgICAgICAgcmV0dXJuIHpvb207XHJcbiAgICAgIH07XHJcbiAgICAgIHZhciBkZXRhY2ggPSBmdW5jdGlvbiBkZXRhY2goKSB7XHJcbiAgICAgICAgZm9yICh2YXIgX2xlbjIgPSBhcmd1bWVudHMubGVuZ3RoLCBzZWxlY3RvcnMgPSBBcnJheShfbGVuMiksIF9rZXkyID0gMDsgX2tleTIgPCBfbGVuMjsgX2tleTIrKykge1xyXG4gICAgICAgICAgc2VsZWN0b3JzW19rZXkyXSA9IGFyZ3VtZW50c1tfa2V5Ml07XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGlmIChhY3RpdmUuem9vbWVkKSB7XHJcbiAgICAgICAgICBjbG9zZSgpO1xyXG4gICAgICAgIH1cclxuICAgICAgICB2YXIgaW1hZ2VzVG9EZXRhY2ggPSBzZWxlY3RvcnMubGVuZ3RoID4gMCA/IHNlbGVjdG9ycy5yZWR1Y2UoZnVuY3Rpb24oaW1hZ2VzQWNjdW11bGF0b3IsIGN1cnJlbnRTZWxlY3Rvcikge1xyXG4gICAgICAgICAgcmV0dXJuIFtdLmNvbmNhdChpbWFnZXNBY2N1bXVsYXRvciwgZ2V0SW1hZ2VzRnJvbVNlbGVjdG9yKGN1cnJlbnRTZWxlY3RvcikpO1xyXG4gICAgICAgIH0sIFtdKSA6IGltYWdlcztcclxuICAgICAgICBpbWFnZXNUb0RldGFjaC5mb3JFYWNoKGZ1bmN0aW9uKGltYWdlKSB7XHJcbiAgICAgICAgICBpbWFnZS5jbGFzc0xpc3QucmVtb3ZlKFwibWVkaXVtLXpvb20taW1hZ2VcIik7XHJcbiAgICAgICAgICBpbWFnZS5kaXNwYXRjaEV2ZW50KGNyZWF0ZUN1c3RvbUV2ZW50KFwibWVkaXVtLXpvb206ZGV0YWNoXCIsIHtcclxuICAgICAgICAgICAgZGV0YWlsOiB7XHJcbiAgICAgICAgICAgICAgem9vbTogem9vbVxyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICB9KSk7XHJcbiAgICAgICAgfSk7XHJcbiAgICAgICAgaW1hZ2VzID0gaW1hZ2VzLmZpbHRlcihmdW5jdGlvbihpbWFnZSkge1xyXG4gICAgICAgICAgcmV0dXJuIGltYWdlc1RvRGV0YWNoLmluZGV4T2YoaW1hZ2UpID09PSAtMTtcclxuICAgICAgICB9KTtcclxuICAgICAgICByZXR1cm4gem9vbTtcclxuICAgICAgfTtcclxuICAgICAgdmFyIG9uID0gZnVuY3Rpb24gb24odHlwZSwgbGlzdGVuZXIpIHtcclxuICAgICAgICB2YXIgb3B0aW9ucyA9IGFyZ3VtZW50cy5sZW5ndGggPiAyICYmIGFyZ3VtZW50c1syXSAhPT0gdW5kZWZpbmVkID8gYXJndW1lbnRzWzJdIDoge307XHJcbiAgICAgICAgaW1hZ2VzLmZvckVhY2goZnVuY3Rpb24oaW1hZ2UpIHtcclxuICAgICAgICAgIGltYWdlLmFkZEV2ZW50TGlzdGVuZXIoXCJtZWRpdW0tem9vbTpcIiArIHR5cGUsIGxpc3RlbmVyLCBvcHRpb25zKTtcclxuICAgICAgICB9KTtcclxuICAgICAgICBldmVudExpc3RlbmVycy5wdXNoKHtcclxuICAgICAgICAgIHR5cGU6IFwibWVkaXVtLXpvb206XCIgKyB0eXBlLFxyXG4gICAgICAgICAgbGlzdGVuZXI6IGxpc3RlbmVyLFxyXG4gICAgICAgICAgb3B0aW9uczogb3B0aW9uc1xyXG4gICAgICAgIH0pO1xyXG4gICAgICAgIHJldHVybiB6b29tO1xyXG4gICAgICB9O1xyXG4gICAgICB2YXIgb2ZmID0gZnVuY3Rpb24gb2ZmKHR5cGUsIGxpc3RlbmVyKSB7XHJcbiAgICAgICAgdmFyIG9wdGlvbnMgPSBhcmd1bWVudHMubGVuZ3RoID4gMiAmJiBhcmd1bWVudHNbMl0gIT09IHVuZGVmaW5lZCA/IGFyZ3VtZW50c1syXSA6IHt9O1xyXG4gICAgICAgIGltYWdlcy5mb3JFYWNoKGZ1bmN0aW9uKGltYWdlKSB7XHJcbiAgICAgICAgICBpbWFnZS5yZW1vdmVFdmVudExpc3RlbmVyKFwibWVkaXVtLXpvb206XCIgKyB0eXBlLCBsaXN0ZW5lciwgb3B0aW9ucyk7XHJcbiAgICAgICAgfSk7XHJcbiAgICAgICAgZXZlbnRMaXN0ZW5lcnMgPSBldmVudExpc3RlbmVycy5maWx0ZXIoZnVuY3Rpb24oZXZlbnRMaXN0ZW5lcikge1xyXG4gICAgICAgICAgcmV0dXJuICEoZXZlbnRMaXN0ZW5lci50eXBlID09PSBcIm1lZGl1bS16b29tOlwiICsgdHlwZSAmJiBldmVudExpc3RlbmVyLmxpc3RlbmVyLnRvU3RyaW5nKCkgPT09IGxpc3RlbmVyLnRvU3RyaW5nKCkpO1xyXG4gICAgICAgIH0pO1xyXG4gICAgICAgIHJldHVybiB6b29tO1xyXG4gICAgICB9O1xyXG4gICAgICB2YXIgb3BlbiA9IGZ1bmN0aW9uIG9wZW4oKSB7XHJcbiAgICAgICAgdmFyIF9yZWYyID0gYXJndW1lbnRzLmxlbmd0aCA+IDAgJiYgYXJndW1lbnRzWzBdICE9PSB1bmRlZmluZWQgPyBhcmd1bWVudHNbMF0gOiB7fSwgdGFyZ2V0ID0gX3JlZjIudGFyZ2V0O1xyXG4gICAgICAgIHZhciBfYW5pbWF0ZSA9IGZ1bmN0aW9uIF9hbmltYXRlKCkge1xyXG4gICAgICAgICAgdmFyIGNvbnRhaW5lciA9IHtcclxuICAgICAgICAgICAgd2lkdGg6IGRvY3VtZW50LmRvY3VtZW50RWxlbWVudC5jbGllbnRXaWR0aCxcclxuICAgICAgICAgICAgaGVpZ2h0OiBkb2N1bWVudC5kb2N1bWVudEVsZW1lbnQuY2xpZW50SGVpZ2h0LFxyXG4gICAgICAgICAgICBsZWZ0OiAwLFxyXG4gICAgICAgICAgICB0b3A6IDAsXHJcbiAgICAgICAgICAgIHJpZ2h0OiAwLFxyXG4gICAgICAgICAgICBib3R0b206IDBcclxuICAgICAgICAgIH07XHJcbiAgICAgICAgICB2YXIgdmlld3BvcnRXaWR0aCA9IHZvaWQgMDtcclxuICAgICAgICAgIHZhciB2aWV3cG9ydEhlaWdodCA9IHZvaWQgMDtcclxuICAgICAgICAgIGlmICh6b29tT3B0aW9ucy5jb250YWluZXIpIHtcclxuICAgICAgICAgICAgaWYgKHpvb21PcHRpb25zLmNvbnRhaW5lciBpbnN0YW5jZW9mIE9iamVjdCkge1xyXG4gICAgICAgICAgICAgIGNvbnRhaW5lciA9IF9leHRlbmRzKHt9LCBjb250YWluZXIsIHpvb21PcHRpb25zLmNvbnRhaW5lcik7XHJcbiAgICAgICAgICAgICAgdmlld3BvcnRXaWR0aCA9IGNvbnRhaW5lci53aWR0aCAtIGNvbnRhaW5lci5sZWZ0IC0gY29udGFpbmVyLnJpZ2h0IC0gem9vbU9wdGlvbnMubWFyZ2luICogMjtcclxuICAgICAgICAgICAgICB2aWV3cG9ydEhlaWdodCA9IGNvbnRhaW5lci5oZWlnaHQgLSBjb250YWluZXIudG9wIC0gY29udGFpbmVyLmJvdHRvbSAtIHpvb21PcHRpb25zLm1hcmdpbiAqIDI7XHJcbiAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgdmFyIHpvb21Db250YWluZXIgPSBpc05vZGUoem9vbU9wdGlvbnMuY29udGFpbmVyKSA/IHpvb21PcHRpb25zLmNvbnRhaW5lciA6IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3Ioem9vbU9wdGlvbnMuY29udGFpbmVyKTtcclxuICAgICAgICAgICAgICB2YXIgX3pvb21Db250YWluZXIkZ2V0Qm91ID0gem9vbUNvbnRhaW5lci5nZXRCb3VuZGluZ0NsaWVudFJlY3QoKSwgX3dpZHRoID0gX3pvb21Db250YWluZXIkZ2V0Qm91LndpZHRoLCBfaGVpZ2h0ID0gX3pvb21Db250YWluZXIkZ2V0Qm91LmhlaWdodCwgX2xlZnQgPSBfem9vbUNvbnRhaW5lciRnZXRCb3UubGVmdCwgX3RvcCA9IF96b29tQ29udGFpbmVyJGdldEJvdS50b3A7XHJcbiAgICAgICAgICAgICAgY29udGFpbmVyID0gX2V4dGVuZHMoe30sIGNvbnRhaW5lciwge1xyXG4gICAgICAgICAgICAgICAgd2lkdGg6IF93aWR0aCxcclxuICAgICAgICAgICAgICAgIGhlaWdodDogX2hlaWdodCxcclxuICAgICAgICAgICAgICAgIGxlZnQ6IF9sZWZ0LFxyXG4gICAgICAgICAgICAgICAgdG9wOiBfdG9wXHJcbiAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgIH1cclxuICAgICAgICAgIHZpZXdwb3J0V2lkdGggPSB2aWV3cG9ydFdpZHRoIHx8IGNvbnRhaW5lci53aWR0aCAtIHpvb21PcHRpb25zLm1hcmdpbiAqIDI7XHJcbiAgICAgICAgICB2aWV3cG9ydEhlaWdodCA9IHZpZXdwb3J0SGVpZ2h0IHx8IGNvbnRhaW5lci5oZWlnaHQgLSB6b29tT3B0aW9ucy5tYXJnaW4gKiAyO1xyXG4gICAgICAgICAgdmFyIHpvb21UYXJnZXQgPSBhY3RpdmUuem9vbWVkSGQgfHwgYWN0aXZlLm9yaWdpbmFsO1xyXG4gICAgICAgICAgdmFyIG5hdHVyYWxXaWR0aCA9IGlzU3ZnKHpvb21UYXJnZXQpID8gdmlld3BvcnRXaWR0aCA6IHpvb21UYXJnZXQubmF0dXJhbFdpZHRoIHx8IHZpZXdwb3J0V2lkdGg7XHJcbiAgICAgICAgICB2YXIgbmF0dXJhbEhlaWdodCA9IGlzU3ZnKHpvb21UYXJnZXQpID8gdmlld3BvcnRIZWlnaHQgOiB6b29tVGFyZ2V0Lm5hdHVyYWxIZWlnaHQgfHwgdmlld3BvcnRIZWlnaHQ7XHJcbiAgICAgICAgICB2YXIgX3pvb21UYXJnZXQkZ2V0Qm91bmRpID0gem9vbVRhcmdldC5nZXRCb3VuZGluZ0NsaWVudFJlY3QoKSwgdG9wID0gX3pvb21UYXJnZXQkZ2V0Qm91bmRpLnRvcCwgbGVmdCA9IF96b29tVGFyZ2V0JGdldEJvdW5kaS5sZWZ0LCB3aWR0aCA9IF96b29tVGFyZ2V0JGdldEJvdW5kaS53aWR0aCwgaGVpZ2h0ID0gX3pvb21UYXJnZXQkZ2V0Qm91bmRpLmhlaWdodDtcclxuICAgICAgICAgIHZhciBzY2FsZVggPSBNYXRoLm1pbihuYXR1cmFsV2lkdGgsIHZpZXdwb3J0V2lkdGgpIC8gd2lkdGg7XHJcbiAgICAgICAgICB2YXIgc2NhbGVZID0gTWF0aC5taW4obmF0dXJhbEhlaWdodCwgdmlld3BvcnRIZWlnaHQpIC8gaGVpZ2h0O1xyXG4gICAgICAgICAgdmFyIHNjYWxlID0gTWF0aC5taW4oc2NhbGVYLCBzY2FsZVkpO1xyXG4gICAgICAgICAgdmFyIHRyYW5zbGF0ZVggPSAoLWxlZnQgKyAodmlld3BvcnRXaWR0aCAtIHdpZHRoKSAvIDIgKyB6b29tT3B0aW9ucy5tYXJnaW4gKyBjb250YWluZXIubGVmdCkgLyBzY2FsZTtcclxuICAgICAgICAgIHZhciB0cmFuc2xhdGVZID0gKC10b3AgKyAodmlld3BvcnRIZWlnaHQgLSBoZWlnaHQpIC8gMiArIHpvb21PcHRpb25zLm1hcmdpbiArIGNvbnRhaW5lci50b3ApIC8gc2NhbGU7XHJcbiAgICAgICAgICB2YXIgdHJhbnNmb3JtID0gXCJzY2FsZShcIiArIHNjYWxlICsgXCIpIHRyYW5zbGF0ZTNkKFwiICsgdHJhbnNsYXRlWCArIFwicHgsIFwiICsgdHJhbnNsYXRlWSArIFwicHgsIDApXCI7XHJcbiAgICAgICAgICBhY3RpdmUuem9vbWVkLnN0eWxlLnRyYW5zZm9ybSA9IHRyYW5zZm9ybTtcclxuICAgICAgICAgIGlmIChhY3RpdmUuem9vbWVkSGQpIHtcclxuICAgICAgICAgICAgYWN0aXZlLnpvb21lZEhkLnN0eWxlLnRyYW5zZm9ybSA9IHRyYW5zZm9ybTtcclxuICAgICAgICAgIH1cclxuICAgICAgICB9O1xyXG4gICAgICAgIHJldHVybiBuZXcgUHJvbWlzZShmdW5jdGlvbihyZXNvbHZlKSB7XHJcbiAgICAgICAgICBpZiAodGFyZ2V0ICYmIGltYWdlcy5pbmRleE9mKHRhcmdldCkgPT09IC0xKSB7XHJcbiAgICAgICAgICAgIHJlc29sdmUoem9vbSk7XHJcbiAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICAgIH1cclxuICAgICAgICAgIHZhciBfaGFuZGxlT3BlbkVuZCA9IGZ1bmN0aW9uIF9oYW5kbGVPcGVuRW5kKCkge1xyXG4gICAgICAgICAgICBpc0FuaW1hdGluZyA9IGZhbHNlO1xyXG4gICAgICAgICAgICBhY3RpdmUuem9vbWVkLnJlbW92ZUV2ZW50TGlzdGVuZXIoXCJ0cmFuc2l0aW9uZW5kXCIsIF9oYW5kbGVPcGVuRW5kKTtcclxuICAgICAgICAgICAgYWN0aXZlLm9yaWdpbmFsLmRpc3BhdGNoRXZlbnQoY3JlYXRlQ3VzdG9tRXZlbnQoXCJtZWRpdW0tem9vbTpvcGVuZWRcIiwge1xyXG4gICAgICAgICAgICAgIGRldGFpbDoge1xyXG4gICAgICAgICAgICAgICAgem9vbTogem9vbVxyXG4gICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfSkpO1xyXG4gICAgICAgICAgICByZXNvbHZlKHpvb20pO1xyXG4gICAgICAgICAgfTtcclxuICAgICAgICAgIGlmIChhY3RpdmUuem9vbWVkKSB7XHJcbiAgICAgICAgICAgIHJlc29sdmUoem9vbSk7XHJcbiAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICAgIH1cclxuICAgICAgICAgIGlmICh0YXJnZXQpIHtcclxuICAgICAgICAgICAgYWN0aXZlLm9yaWdpbmFsID0gdGFyZ2V0O1xyXG4gICAgICAgICAgfSBlbHNlIGlmIChpbWFnZXMubGVuZ3RoID4gMCkge1xyXG4gICAgICAgICAgICB2YXIgX2ltYWdlcyA9IGltYWdlcztcclxuICAgICAgICAgICAgYWN0aXZlLm9yaWdpbmFsID0gX2ltYWdlc1swXTtcclxuICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgIHJlc29sdmUoem9vbSk7XHJcbiAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICAgIH1cclxuICAgICAgICAgIGFjdGl2ZS5vcmlnaW5hbC5kaXNwYXRjaEV2ZW50KGNyZWF0ZUN1c3RvbUV2ZW50KFwibWVkaXVtLXpvb206b3BlblwiLCB7XHJcbiAgICAgICAgICAgIGRldGFpbDoge1xyXG4gICAgICAgICAgICAgIHpvb206IHpvb21cclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgfSkpO1xyXG4gICAgICAgICAgc2Nyb2xsVG9wID0gd2luZG93LnBhZ2VZT2Zmc2V0IHx8IGRvY3VtZW50LmRvY3VtZW50RWxlbWVudC5zY3JvbGxUb3AgfHwgZG9jdW1lbnQuYm9keS5zY3JvbGxUb3AgfHwgMDtcclxuICAgICAgICAgIGlzQW5pbWF0aW5nID0gdHJ1ZTtcclxuICAgICAgICAgIGFjdGl2ZS56b29tZWQgPSBjbG9uZVRhcmdldChhY3RpdmUub3JpZ2luYWwpO1xyXG4gICAgICAgICAgZG9jdW1lbnQuYm9keS5hcHBlbmRDaGlsZChvdmVybGF5KTtcclxuICAgICAgICAgIGlmICh6b29tT3B0aW9ucy50ZW1wbGF0ZSkge1xyXG4gICAgICAgICAgICB2YXIgdGVtcGxhdGUgPSBpc05vZGUoem9vbU9wdGlvbnMudGVtcGxhdGUpID8gem9vbU9wdGlvbnMudGVtcGxhdGUgOiBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKHpvb21PcHRpb25zLnRlbXBsYXRlKTtcclxuICAgICAgICAgICAgYWN0aXZlLnRlbXBsYXRlID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudChcImRpdlwiKTtcclxuICAgICAgICAgICAgYWN0aXZlLnRlbXBsYXRlLmFwcGVuZENoaWxkKHRlbXBsYXRlLmNvbnRlbnQuY2xvbmVOb2RlKHRydWUpKTtcclxuICAgICAgICAgICAgZG9jdW1lbnQuYm9keS5hcHBlbmRDaGlsZChhY3RpdmUudGVtcGxhdGUpO1xyXG4gICAgICAgICAgfVxyXG4gICAgICAgICAgZG9jdW1lbnQuYm9keS5hcHBlbmRDaGlsZChhY3RpdmUuem9vbWVkKTtcclxuICAgICAgICAgIHdpbmRvdy5yZXF1ZXN0QW5pbWF0aW9uRnJhbWUoZnVuY3Rpb24oKSB7XHJcbiAgICAgICAgICAgIGRvY3VtZW50LmJvZHkuY2xhc3NMaXN0LmFkZChcIm1lZGl1bS16b29tLS1vcGVuZWRcIik7XHJcbiAgICAgICAgICB9KTtcclxuICAgICAgICAgIGFjdGl2ZS5vcmlnaW5hbC5jbGFzc0xpc3QuYWRkKFwibWVkaXVtLXpvb20taW1hZ2UtLWhpZGRlblwiKTtcclxuICAgICAgICAgIGFjdGl2ZS56b29tZWQuY2xhc3NMaXN0LmFkZChcIm1lZGl1bS16b29tLWltYWdlLS1vcGVuZWRcIik7XHJcbiAgICAgICAgICBhY3RpdmUuem9vbWVkLmFkZEV2ZW50TGlzdGVuZXIoXCJjbGlja1wiLCBjbG9zZSk7XHJcbiAgICAgICAgICBhY3RpdmUuem9vbWVkLmFkZEV2ZW50TGlzdGVuZXIoXCJ0cmFuc2l0aW9uZW5kXCIsIF9oYW5kbGVPcGVuRW5kKTtcclxuICAgICAgICAgIGlmIChhY3RpdmUub3JpZ2luYWwuZ2V0QXR0cmlidXRlKFwiZGF0YS16b29tLXNyY1wiKSkge1xyXG4gICAgICAgICAgICBhY3RpdmUuem9vbWVkSGQgPSBhY3RpdmUuem9vbWVkLmNsb25lTm9kZSgpO1xyXG4gICAgICAgICAgICBhY3RpdmUuem9vbWVkSGQucmVtb3ZlQXR0cmlidXRlKFwic3Jjc2V0XCIpO1xyXG4gICAgICAgICAgICBhY3RpdmUuem9vbWVkSGQucmVtb3ZlQXR0cmlidXRlKFwic2l6ZXNcIik7XHJcbiAgICAgICAgICAgIGFjdGl2ZS56b29tZWRIZC5zcmMgPSBhY3RpdmUuem9vbWVkLmdldEF0dHJpYnV0ZShcImRhdGEtem9vbS1zcmNcIik7XHJcbiAgICAgICAgICAgIGFjdGl2ZS56b29tZWRIZC5vbmVycm9yID0gZnVuY3Rpb24oKSB7XHJcbiAgICAgICAgICAgICAgY2xlYXJJbnRlcnZhbChnZXRab29tVGFyZ2V0U2l6ZSk7XHJcbiAgICAgICAgICAgICAgY29uc29sZS53YXJuKFwiVW5hYmxlIHRvIHJlYWNoIHRoZSB6b29tIGltYWdlIHRhcmdldCBcIiArIGFjdGl2ZS56b29tZWRIZC5zcmMpO1xyXG4gICAgICAgICAgICAgIGFjdGl2ZS56b29tZWRIZCA9IG51bGw7XHJcbiAgICAgICAgICAgICAgX2FuaW1hdGUoKTtcclxuICAgICAgICAgICAgfTtcclxuICAgICAgICAgICAgdmFyIGdldFpvb21UYXJnZXRTaXplID0gc2V0SW50ZXJ2YWwoZnVuY3Rpb24oKSB7XHJcbiAgICAgICAgICAgICAgaWYgKGFjdGl2ZS56b29tZWRIZC5jb21wbGV0ZSkge1xyXG4gICAgICAgICAgICAgICAgY2xlYXJJbnRlcnZhbChnZXRab29tVGFyZ2V0U2l6ZSk7XHJcbiAgICAgICAgICAgICAgICBhY3RpdmUuem9vbWVkSGQuY2xhc3NMaXN0LmFkZChcIm1lZGl1bS16b29tLWltYWdlLS1vcGVuZWRcIik7XHJcbiAgICAgICAgICAgICAgICBhY3RpdmUuem9vbWVkSGQuYWRkRXZlbnRMaXN0ZW5lcihcImNsaWNrXCIsIGNsb3NlKTtcclxuICAgICAgICAgICAgICAgIGRvY3VtZW50LmJvZHkuYXBwZW5kQ2hpbGQoYWN0aXZlLnpvb21lZEhkKTtcclxuICAgICAgICAgICAgICAgIF9hbmltYXRlKCk7XHJcbiAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9LCAxMCk7XHJcbiAgICAgICAgICB9IGVsc2UgaWYgKGFjdGl2ZS5vcmlnaW5hbC5oYXNBdHRyaWJ1dGUoXCJzcmNzZXRcIikpIHtcclxuICAgICAgICAgICAgYWN0aXZlLnpvb21lZEhkID0gYWN0aXZlLnpvb21lZC5jbG9uZU5vZGUoKTtcclxuICAgICAgICAgICAgYWN0aXZlLnpvb21lZEhkLnJlbW92ZUF0dHJpYnV0ZShcInNpemVzXCIpO1xyXG4gICAgICAgICAgICB2YXIgbG9hZEV2ZW50TGlzdGVuZXIgPSBhY3RpdmUuem9vbWVkSGQuYWRkRXZlbnRMaXN0ZW5lcihcImxvYWRcIiwgZnVuY3Rpb24oKSB7XHJcbiAgICAgICAgICAgICAgYWN0aXZlLnpvb21lZEhkLnJlbW92ZUV2ZW50TGlzdGVuZXIoXCJsb2FkXCIsIGxvYWRFdmVudExpc3RlbmVyKTtcclxuICAgICAgICAgICAgICBhY3RpdmUuem9vbWVkSGQuY2xhc3NMaXN0LmFkZChcIm1lZGl1bS16b29tLWltYWdlLS1vcGVuZWRcIik7XHJcbiAgICAgICAgICAgICAgYWN0aXZlLnpvb21lZEhkLmFkZEV2ZW50TGlzdGVuZXIoXCJjbGlja1wiLCBjbG9zZSk7XHJcbiAgICAgICAgICAgICAgZG9jdW1lbnQuYm9keS5hcHBlbmRDaGlsZChhY3RpdmUuem9vbWVkSGQpO1xyXG4gICAgICAgICAgICAgIF9hbmltYXRlKCk7XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgX2FuaW1hdGUoKTtcclxuICAgICAgICAgIH1cclxuICAgICAgICB9KTtcclxuICAgICAgfTtcclxuICAgICAgdmFyIGNsb3NlID0gZnVuY3Rpb24gY2xvc2UoKSB7XHJcbiAgICAgICAgcmV0dXJuIG5ldyBQcm9taXNlKGZ1bmN0aW9uKHJlc29sdmUpIHtcclxuICAgICAgICAgIGlmIChpc0FuaW1hdGluZyB8fCAhYWN0aXZlLm9yaWdpbmFsKSB7XHJcbiAgICAgICAgICAgIHJlc29sdmUoem9vbSk7XHJcbiAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICAgIH1cclxuICAgICAgICAgIHZhciBfaGFuZGxlQ2xvc2VFbmQgPSBmdW5jdGlvbiBfaGFuZGxlQ2xvc2VFbmQoKSB7XHJcbiAgICAgICAgICAgIGFjdGl2ZS5vcmlnaW5hbC5jbGFzc0xpc3QucmVtb3ZlKFwibWVkaXVtLXpvb20taW1hZ2UtLWhpZGRlblwiKTtcclxuICAgICAgICAgICAgZG9jdW1lbnQuYm9keS5yZW1vdmVDaGlsZChhY3RpdmUuem9vbWVkKTtcclxuICAgICAgICAgICAgaWYgKGFjdGl2ZS56b29tZWRIZCkge1xyXG4gICAgICAgICAgICAgIGRvY3VtZW50LmJvZHkucmVtb3ZlQ2hpbGQoYWN0aXZlLnpvb21lZEhkKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBkb2N1bWVudC5ib2R5LnJlbW92ZUNoaWxkKG92ZXJsYXkpO1xyXG4gICAgICAgICAgICBhY3RpdmUuem9vbWVkLmNsYXNzTGlzdC5yZW1vdmUoXCJtZWRpdW0tem9vbS1pbWFnZS0tb3BlbmVkXCIpO1xyXG4gICAgICAgICAgICBpZiAoYWN0aXZlLnRlbXBsYXRlKSB7XHJcbiAgICAgICAgICAgICAgZG9jdW1lbnQuYm9keS5yZW1vdmVDaGlsZChhY3RpdmUudGVtcGxhdGUpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIGlzQW5pbWF0aW5nID0gZmFsc2U7XHJcbiAgICAgICAgICAgIGFjdGl2ZS56b29tZWQucmVtb3ZlRXZlbnRMaXN0ZW5lcihcInRyYW5zaXRpb25lbmRcIiwgX2hhbmRsZUNsb3NlRW5kKTtcclxuICAgICAgICAgICAgYWN0aXZlLm9yaWdpbmFsLmRpc3BhdGNoRXZlbnQoY3JlYXRlQ3VzdG9tRXZlbnQoXCJtZWRpdW0tem9vbTpjbG9zZWRcIiwge1xyXG4gICAgICAgICAgICAgIGRldGFpbDoge1xyXG4gICAgICAgICAgICAgICAgem9vbTogem9vbVxyXG4gICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfSkpO1xyXG4gICAgICAgICAgICBhY3RpdmUub3JpZ2luYWwgPSBudWxsO1xyXG4gICAgICAgICAgICBhY3RpdmUuem9vbWVkID0gbnVsbDtcclxuICAgICAgICAgICAgYWN0aXZlLnpvb21lZEhkID0gbnVsbDtcclxuICAgICAgICAgICAgYWN0aXZlLnRlbXBsYXRlID0gbnVsbDtcclxuICAgICAgICAgICAgcmVzb2x2ZSh6b29tKTtcclxuICAgICAgICAgIH07XHJcbiAgICAgICAgICBpc0FuaW1hdGluZyA9IHRydWU7XHJcbiAgICAgICAgICBkb2N1bWVudC5ib2R5LmNsYXNzTGlzdC5yZW1vdmUoXCJtZWRpdW0tem9vbS0tb3BlbmVkXCIpO1xyXG4gICAgICAgICAgYWN0aXZlLnpvb21lZC5zdHlsZS50cmFuc2Zvcm0gPSBcIlwiO1xyXG4gICAgICAgICAgaWYgKGFjdGl2ZS56b29tZWRIZCkge1xyXG4gICAgICAgICAgICBhY3RpdmUuem9vbWVkSGQuc3R5bGUudHJhbnNmb3JtID0gXCJcIjtcclxuICAgICAgICAgIH1cclxuICAgICAgICAgIGlmIChhY3RpdmUudGVtcGxhdGUpIHtcclxuICAgICAgICAgICAgYWN0aXZlLnRlbXBsYXRlLnN0eWxlLnRyYW5zaXRpb24gPSBcIm9wYWNpdHkgMTUwbXNcIjtcclxuICAgICAgICAgICAgYWN0aXZlLnRlbXBsYXRlLnN0eWxlLm9wYWNpdHkgPSAwO1xyXG4gICAgICAgICAgfVxyXG4gICAgICAgICAgYWN0aXZlLm9yaWdpbmFsLmRpc3BhdGNoRXZlbnQoY3JlYXRlQ3VzdG9tRXZlbnQoXCJtZWRpdW0tem9vbTpjbG9zZVwiLCB7XHJcbiAgICAgICAgICAgIGRldGFpbDoge1xyXG4gICAgICAgICAgICAgIHpvb206IHpvb21cclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgfSkpO1xyXG4gICAgICAgICAgYWN0aXZlLnpvb21lZC5hZGRFdmVudExpc3RlbmVyKFwidHJhbnNpdGlvbmVuZFwiLCBfaGFuZGxlQ2xvc2VFbmQpO1xyXG4gICAgICAgIH0pO1xyXG4gICAgICB9O1xyXG4gICAgICB2YXIgdG9nZ2xlID0gZnVuY3Rpb24gdG9nZ2xlKCkge1xyXG4gICAgICAgIHZhciBfcmVmMyA9IGFyZ3VtZW50cy5sZW5ndGggPiAwICYmIGFyZ3VtZW50c1swXSAhPT0gdW5kZWZpbmVkID8gYXJndW1lbnRzWzBdIDoge30sIHRhcmdldCA9IF9yZWYzLnRhcmdldDtcclxuICAgICAgICBpZiAoYWN0aXZlLm9yaWdpbmFsKSB7XHJcbiAgICAgICAgICByZXR1cm4gY2xvc2UoKTtcclxuICAgICAgICB9XHJcbiAgICAgICAgcmV0dXJuIG9wZW4oe1xyXG4gICAgICAgICAgdGFyZ2V0OiB0YXJnZXRcclxuICAgICAgICB9KTtcclxuICAgICAgfTtcclxuICAgICAgdmFyIGdldE9wdGlvbnMgPSBmdW5jdGlvbiBnZXRPcHRpb25zKCkge1xyXG4gICAgICAgIHJldHVybiB6b29tT3B0aW9ucztcclxuICAgICAgfTtcclxuICAgICAgdmFyIGdldEltYWdlcyA9IGZ1bmN0aW9uIGdldEltYWdlcygpIHtcclxuICAgICAgICByZXR1cm4gaW1hZ2VzO1xyXG4gICAgICB9O1xyXG4gICAgICB2YXIgZ2V0Wm9vbWVkSW1hZ2UgPSBmdW5jdGlvbiBnZXRab29tZWRJbWFnZSgpIHtcclxuICAgICAgICByZXR1cm4gYWN0aXZlLm9yaWdpbmFsO1xyXG4gICAgICB9O1xyXG4gICAgICB2YXIgaW1hZ2VzID0gW107XHJcbiAgICAgIHZhciBldmVudExpc3RlbmVycyA9IFtdO1xyXG4gICAgICB2YXIgaXNBbmltYXRpbmcgPSBmYWxzZTtcclxuICAgICAgdmFyIHNjcm9sbFRvcCA9IDA7XHJcbiAgICAgIHZhciB6b29tT3B0aW9ucyA9IG9wdGlvbnM7XHJcbiAgICAgIHZhciBhY3RpdmUgPSB7XHJcbiAgICAgICAgb3JpZ2luYWw6IG51bGwsXHJcbiAgICAgICAgem9vbWVkOiBudWxsLFxyXG4gICAgICAgIHpvb21lZEhkOiBudWxsLFxyXG4gICAgICAgIHRlbXBsYXRlOiBudWxsXHJcbiAgICAgIH07XHJcbiAgICAgIGlmIChPYmplY3QucHJvdG90eXBlLnRvU3RyaW5nLmNhbGwoc2VsZWN0b3IpID09PSBcIltvYmplY3QgT2JqZWN0XVwiKSB7XHJcbiAgICAgICAgem9vbU9wdGlvbnMgPSBzZWxlY3RvcjtcclxuICAgICAgfSBlbHNlIGlmIChzZWxlY3RvciB8fCB0eXBlb2Ygc2VsZWN0b3IgPT09IFwic3RyaW5nXCIpIHtcclxuICAgICAgICBhdHRhY2goc2VsZWN0b3IpO1xyXG4gICAgICB9XHJcbiAgICAgIHpvb21PcHRpb25zID0gX2V4dGVuZHMoe1xyXG4gICAgICAgIG1hcmdpbjogMCxcclxuICAgICAgICBiYWNrZ3JvdW5kOiBcIiNmZmZcIixcclxuICAgICAgICBzY3JvbGxPZmZzZXQ6IDQwLFxyXG4gICAgICAgIGNvbnRhaW5lcjogbnVsbCxcclxuICAgICAgICB0ZW1wbGF0ZTogbnVsbFxyXG4gICAgICB9LCB6b29tT3B0aW9ucyk7XHJcbiAgICAgIHZhciBvdmVybGF5ID0gY3JlYXRlT3ZlcmxheSh6b29tT3B0aW9ucy5iYWNrZ3JvdW5kKTtcclxuICAgICAgZG9jdW1lbnQuYWRkRXZlbnRMaXN0ZW5lcihcImNsaWNrXCIsIF9oYW5kbGVDbGljayk7XHJcbiAgICAgIGRvY3VtZW50LmFkZEV2ZW50TGlzdGVuZXIoXCJrZXl1cFwiLCBfaGFuZGxlS2V5VXApO1xyXG4gICAgICBkb2N1bWVudC5hZGRFdmVudExpc3RlbmVyKFwic2Nyb2xsXCIsIF9oYW5kbGVTY3JvbGwpO1xyXG4gICAgICB3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcihcInJlc2l6ZVwiLCBjbG9zZSk7XHJcbiAgICAgIHZhciB6b29tID0ge1xyXG4gICAgICAgIG9wZW46IG9wZW4sXHJcbiAgICAgICAgY2xvc2U6IGNsb3NlLFxyXG4gICAgICAgIHRvZ2dsZTogdG9nZ2xlLFxyXG4gICAgICAgIHVwZGF0ZTogdXBkYXRlLFxyXG4gICAgICAgIGNsb25lOiBjbG9uZSxcclxuICAgICAgICBhdHRhY2g6IGF0dGFjaCxcclxuICAgICAgICBkZXRhY2g6IGRldGFjaCxcclxuICAgICAgICBvbjogb24sXHJcbiAgICAgICAgb2ZmOiBvZmYsXHJcbiAgICAgICAgZ2V0T3B0aW9uczogZ2V0T3B0aW9ucyxcclxuICAgICAgICBnZXRJbWFnZXM6IGdldEltYWdlcyxcclxuICAgICAgICBnZXRab29tZWRJbWFnZTogZ2V0Wm9vbWVkSW1hZ2VcclxuICAgICAgfTtcclxuICAgICAgcmV0dXJuIHpvb207XHJcbiAgICB9O1xyXG4gICAgZnVuY3Rpb24gc3R5bGVJbmplY3QoY3NzLCByZWYpIHtcclxuICAgICAgaWYgKHJlZiA9PT0gdm9pZCAwKSByZWYgPSB7fTtcclxuICAgICAgdmFyIGluc2VydEF0ID0gcmVmLmluc2VydEF0O1xyXG4gICAgICBpZiAoIWNzcyB8fCB0eXBlb2YgZG9jdW1lbnQgPT09IFwidW5kZWZpbmVkXCIpIHtcclxuICAgICAgICByZXR1cm47XHJcbiAgICAgIH1cclxuICAgICAgdmFyIGhlYWQgPSBkb2N1bWVudC5oZWFkIHx8IGRvY3VtZW50LmdldEVsZW1lbnRzQnlUYWdOYW1lKFwiaGVhZFwiKVswXTtcclxuICAgICAgdmFyIHN0eWxlID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudChcInN0eWxlXCIpO1xyXG4gICAgICBzdHlsZS50eXBlID0gXCJ0ZXh0L2Nzc1wiO1xyXG4gICAgICBpZiAoaW5zZXJ0QXQgPT09IFwidG9wXCIpIHtcclxuICAgICAgICBpZiAoaGVhZC5maXJzdENoaWxkKSB7XHJcbiAgICAgICAgICBoZWFkLmluc2VydEJlZm9yZShzdHlsZSwgaGVhZC5maXJzdENoaWxkKTtcclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgaGVhZC5hcHBlbmRDaGlsZChzdHlsZSk7XHJcbiAgICAgICAgfVxyXG4gICAgICB9IGVsc2Uge1xyXG4gICAgICAgIGhlYWQuYXBwZW5kQ2hpbGQoc3R5bGUpO1xyXG4gICAgICB9XHJcbiAgICAgIGlmIChzdHlsZS5zdHlsZVNoZWV0KSB7XHJcbiAgICAgICAgc3R5bGUuc3R5bGVTaGVldC5jc3NUZXh0ID0gY3NzO1xyXG4gICAgICB9IGVsc2Uge1xyXG4gICAgICAgIHN0eWxlLmFwcGVuZENoaWxkKGRvY3VtZW50LmNyZWF0ZVRleHROb2RlKGNzcykpO1xyXG4gICAgICB9XHJcbiAgICB9XHJcbiAgICB2YXIgY3NzID0gXCIubWVkaXVtLXpvb20tb3ZlcmxheXtwb3NpdGlvbjpmaXhlZDt0b3A6MDtyaWdodDowO2JvdHRvbTowO2xlZnQ6MDtvcGFjaXR5OjA7dHJhbnNpdGlvbjpvcGFjaXR5IC4zczt3aWxsLWNoYW5nZTpvcGFjaXR5fS5tZWRpdW0tem9vbS0tb3BlbmVkIC5tZWRpdW0tem9vbS1vdmVybGF5e2N1cnNvcjpwb2ludGVyO2N1cnNvcjp6b29tLW91dDtvcGFjaXR5OjF9Lm1lZGl1bS16b29tLWltYWdle2N1cnNvcjpwb2ludGVyO2N1cnNvcjp6b29tLWluO3RyYW5zaXRpb246dHJhbnNmb3JtIC4zcyBjdWJpYy1iZXppZXIoLjIsMCwuMiwxKX0ubWVkaXVtLXpvb20taW1hZ2UtLWhpZGRlbnt2aXNpYmlsaXR5OmhpZGRlbn0ubWVkaXVtLXpvb20taW1hZ2UtLW9wZW5lZHtwb3NpdGlvbjpyZWxhdGl2ZTtjdXJzb3I6cG9pbnRlcjtjdXJzb3I6em9vbS1vdXQ7d2lsbC1jaGFuZ2U6dHJhbnNmb3JtfVwiO1xyXG4gICAgc3R5bGVJbmplY3QoY3NzKTtcclxuICAgIHJldHVybiBtZWRpdW1ab29tO1xyXG4gIH0pO1xyXG4oKCkgPT4ge1xyXG4gICAgbGV0XHJcbiAgICAgICAgc3dpcGVyID0gZG9jdW1lbnQucXVlcnlTZWxlY3RvcignLm90aGVyLXNlcnZpY2VzX19zd2lwZXInKSxcclxuICAgICAgICBzd2lwZXJMaXN0ID0gZG9jdW1lbnQucXVlcnlTZWxlY3RvcignLm90aGVyLXNlcnZpY2VzX19saXN0JyksXHJcbiAgICAgICAgc3dpcGVyV2lkdGggPSBwYXJzZUludChnZXRDb21wdXRlZFN0eWxlKHN3aXBlcikud2lkdGgpLFxyXG4gICAgICAgIHN3aXBlckxpc3RXaWR0aCA9IHBhcnNlSW50KGdldENvbXB1dGVkU3R5bGUoc3dpcGVyTGlzdCkud2lkdGgpO1xyXG5cclxuXHJcbiAgICB3aW5kb3cub25sb2FkID0gKCkgPT4ge1xyXG4gICAgICAgIGxldCBoZWlnaHRPZlN3aXBlciA9IGdldENvbXB1dGVkU3R5bGUoc3dpcGVyKS5oZWlnaHQ7XHJcbiAgICAgICAgc3dpcGVyLnN0eWxlLmhlaWdodCA9IGAke3BhcnNlSW50KGhlaWdodE9mU3dpcGVyKSArIDQwfXB4YDtcclxuICAgIH1cclxuXHJcblxyXG4gICAgc3dpcGVyTGlzdC5zdHlsZS5tYXJnaW5MZWZ0ID0gJzBweCc7XHJcblxyXG5cclxuICAgIGZ1bmN0aW9uIHN3aXBlKGV2ZW50KSB7XHJcblxyXG4gICAgICAgIHN3aXBlci5hZGRFdmVudExpc3RlbmVyKCdtb3VzZWxlYXZlJywgc3dpdGNoT2ZmU3dpcGVyKTtcclxuXHJcbiAgICAgICAgZnVuY3Rpb24gc3dpdGNoT2ZmU3dpcGVyKCkge1xyXG4gICAgICAgICAgICBzd2lwZXIucmVtb3ZlRXZlbnRMaXN0ZW5lcignbW91c2Vtb3ZlJywgc3dpcGVNb3VzZU1vdmVPbik7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBzd2lwZXIuYWRkRXZlbnRMaXN0ZW5lcignbW91c2V1cCcsIHN3aXBlTW91c2VNb3ZlT2ZmKTtcclxuXHJcbiAgICAgICAgbGV0XHJcbiAgICAgICAgICAgIGZpcnN0Q3Vyc29yUG9zaXRpb24gPSBldmVudC5wYWdlWCxcclxuICAgICAgICAgICAgaW5pdGlhbEN1cnNvclBvc2l0aW9uID0gZXZlbnQucGFnZVgsXHJcbiAgICAgICAgICAgIHN1bW1Td2lwZURpc3RhbmNlID0gMCxcclxuICAgICAgICAgICAgd2F5VG9XaGljaFN3aXBlSXNNYWRlLFxyXG4gICAgICAgICAgICBzd2lwZUxpc3RNYXJnaW5MZWZ0LFxyXG4gICAgICAgICAgICBpc0Zhc3RTd2lwZSA9IGZhbHNlO1xyXG5cclxuICAgICAgICBzd2lwZXIuYWRkRXZlbnRMaXN0ZW5lcignbW91c2Vtb3ZlJywgc3dpcGVNb3VzZU1vdmVPbik7XHJcblxyXG4gICAgICAgIGZ1bmN0aW9uIHN3aXBlTW91c2VNb3ZlT24oZXZlbnQpIHtcclxuXHJcbiAgICAgICAgICAgIGxldFxyXG4gICAgICAgICAgICAgICAgbmV3Q3Vyc29yUG9zaXRpb24gPSBldmVudC5wYWdlWCxcclxuICAgICAgICAgICAgICAgIHN3aXBlRGlzdGFuY2UgPSBNYXRoLmFicyhpbml0aWFsQ3Vyc29yUG9zaXRpb24gLSBuZXdDdXJzb3JQb3NpdGlvbik7XHJcblxyXG4gICAgICAgICAgICBzd2lwZUxpc3RNYXJnaW5MZWZ0ID0gcGFyc2VJbnQoc3dpcGVyTGlzdC5zdHlsZS5tYXJnaW5MZWZ0KTtcclxuXHJcbiAgICAgICAgICAgIGlmIChuZXdDdXJzb3JQb3NpdGlvbiA8IGluaXRpYWxDdXJzb3JQb3NpdGlvbikgd2F5VG9XaGljaFN3aXBlSXNNYWRlID0gJ2xlZnQnO1xyXG4gICAgICAgICAgICBlbHNlIGlmIChuZXdDdXJzb3JQb3NpdGlvbiA+IGluaXRpYWxDdXJzb3JQb3NpdGlvbikgd2F5VG9XaGljaFN3aXBlSXNNYWRlID0gJ3JpZ2h0JztcclxuICAgICAgICAgICAgZWxzZSBpZiAobmV3Q3Vyc29yUG9zaXRpb24gPSBpbml0aWFsQ3Vyc29yUG9zaXRpb24pIHdheVRvV2hpY2hTd2lwZUlzTWFkZSA9IHdheVRvV2hpY2hTd2lwZUlzTWFkZTtcclxuICAgICAgICAgICAgXHJcbiAgICAgICAgICAgIHN3aXRjaCh3YXlUb1doaWNoU3dpcGVJc01hZGUpIHtcclxuICAgICAgICAgICAgICAgIGNhc2UgJ2xlZnQnOlxyXG5cclxuICAgICAgICAgICAgICAgICAgICBpZiAoLXN3aXBlTGlzdE1hcmdpbkxlZnQgPj0gKHN3aXBlckxpc3RXaWR0aCAtIHN3aXBlcldpZHRoKSkgcmV0dXJuO1xyXG4gICAgICAgICAgICAgICAgICAgIHN3aXBlckxpc3Quc3R5bGUubWFyZ2luTGVmdCA9IGAke3N3aXBlTGlzdE1hcmdpbkxlZnQgLSBzd2lwZURpc3RhbmNlfXB4YDtcclxuICAgICAgICAgICAgICAgICAgICBicmVhaztcclxuXHJcbiAgICAgICAgICAgICAgICBjYXNlICdyaWdodCc6XHJcbiAgICAgICAgICAgICAgICAgICAgXHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKHN3aXBlTGlzdE1hcmdpbkxlZnQgPj0gMCApIHJldHVybjtcclxuICAgICAgICAgICAgICAgICAgICBzd2lwZXJMaXN0LnN0eWxlLm1hcmdpbkxlZnQgPSBgJHtzd2lwZUxpc3RNYXJnaW5MZWZ0ICsgc3dpcGVEaXN0YW5jZX1weGA7XHJcbiAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgIHN1bW1Td2lwZURpc3RhbmNlICs9IHN3aXBlRGlzdGFuY2U7XHJcbiAgICAgICAgICAgIGluaXRpYWxDdXJzb3JQb3NpdGlvbiA9IG5ld0N1cnNvclBvc2l0aW9uO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgZnVuY3Rpb24gc3dpcGVNb3VzZU1vdmVPZmYoZXZlbnQpIHtcclxuICAgICAgICAgICAgc3dpcGVyLnJlbW92ZUV2ZW50TGlzdGVuZXIoJ21vdXNlbW92ZScsIHN3aXBlTW91c2VNb3ZlT24pO1xyXG5cclxuICAgICAgICAgICAgaXNGYXN0U3dpcGUgPSAoc3VtbVN3aXBlRGlzdGFuY2UgPj0gMTAwKSA/IHRydWUgOiBmYWxzZTtcclxuICAgICAgICAgICAgaWYgKCFpc0Zhc3RTd2lwZSkgcmV0dXJuO1xyXG5cclxuICAgICAgICAgICAgc3VtbVN3aXBlRGlzdGFuY2UgPSAoc3VtbVN3aXBlRGlzdGFuY2UgPiAoc3dpcGVyTGlzdFdpZHRoIC0gc3dpcGVyV2lkdGgpKSA/IChzd2lwZXJMaXN0V2lkdGggLSBzd2lwZXJXaWR0aCkgOiBzdW1tU3dpcGVEaXN0YW5jZTtcclxuICAgICAgICAgICAgXHJcbiAgICAgICAgICAgIGxldCBhZGRpdGlvbmFsU3dpcGVEaXN0YW5jZSA9IChzdW1tU3dpcGVEaXN0YW5jZSAvIDEuNSk7IC8vIDwtLS0tIGNoYW5nZSBzd2lwZSBzcGVlZCwgZm9yIGV4YW1wbGU6IChzdW1tU3dpcGVEaXN0YW5jZSAvIDIuNSlcclxuXHJcblxyXG4gICAgICAgICAgICBsZXQgbGFzdEN1cnNvclBvc2l0aW9uID0gZXZlbnQucGFnZVg7XHJcbiAgICAgICAgICAgIHdheVRvV2hpY2hTd2lwZUlzTWFkZSA9IChsYXN0Q3Vyc29yUG9zaXRpb24gPCBmaXJzdEN1cnNvclBvc2l0aW9uKSA/ICdsZWZ0JyA6ICdyaWdodCc7XHJcblxyXG4gICAgICAgICAgICBzd2lwZUxpc3RNYXJnaW5MZWZ0ID0gcGFyc2VJbnQoc3dpcGVyTGlzdC5zdHlsZS5tYXJnaW5MZWZ0KTtcclxuXHJcbiAgICAgICAgICAgIHN3aXRjaCh3YXlUb1doaWNoU3dpcGVJc01hZGUpIHtcclxuICAgICAgICAgICAgICAgIGNhc2UgJ2xlZnQnOlxyXG5cclxuICAgICAgICAgICAgICAgICAgICBpZiAoLXN3aXBlTGlzdE1hcmdpbkxlZnQgPj0gKHN3aXBlckxpc3RXaWR0aCAtIHN3aXBlcldpZHRoKSkgcmV0dXJuO1xyXG4gICAgICAgICAgICAgICAgICAgIFxyXG4gICAgICAgICAgICAgICAgICAgIGFkZGl0aW9uYWxTd2lwZURpc3RhbmNlID0gKGFkZGl0aW9uYWxTd2lwZURpc3RhbmNlID4gKChzd2lwZXJMaXN0V2lkdGggLSBzd2lwZXJXaWR0aCkgKyBzd2lwZUxpc3RNYXJnaW5MZWZ0KSkgPyAoKHN3aXBlckxpc3RXaWR0aCAtIHN3aXBlcldpZHRoKSArIHN3aXBlTGlzdE1hcmdpbkxlZnQpIDogYWRkaXRpb25hbFN3aXBlRGlzdGFuY2U7XHJcblxyXG4gICAgICAgICAgICAgICAgICAgIHN3aXBlckxpc3Quc3R5bGUudHJhbnNpdGlvbiA9ICdhbGwgMC4zNXMnO1xyXG4gICAgICAgICAgICAgICAgICAgIHN3aXBlckxpc3Quc3R5bGUubWFyZ2luTGVmdCA9IGAke3N3aXBlTGlzdE1hcmdpbkxlZnQgLSBhZGRpdGlvbmFsU3dpcGVEaXN0YW5jZX1weGA7XHJcbiAgICAgICAgICAgICAgICAgICAgYnJlYWs7XHJcblxyXG4gICAgICAgICAgICAgICAgY2FzZSAncmlnaHQnOlxyXG4gICAgICAgICAgICAgICAgICAgIFxyXG4gICAgICAgICAgICAgICAgICAgIGlmIChzd2lwZUxpc3RNYXJnaW5MZWZ0ID49IDAgKSByZXR1cm47XHJcblxyXG4gICAgICAgICAgICAgICAgICAgIGFkZGl0aW9uYWxTd2lwZURpc3RhbmNlID0gKGFkZGl0aW9uYWxTd2lwZURpc3RhbmNlID4gLXN3aXBlTGlzdE1hcmdpbkxlZnQpID8gLXN3aXBlTGlzdE1hcmdpbkxlZnQgOiBhZGRpdGlvbmFsU3dpcGVEaXN0YW5jZTtcclxuXHJcbiAgICAgICAgICAgICAgICAgICAgc3dpcGVyTGlzdC5zdHlsZS50cmFuc2l0aW9uID0gJ2FsbCAwLjM1cyc7XHJcbiAgICAgICAgICAgICAgICAgICAgc3dpcGVyTGlzdC5zdHlsZS5tYXJnaW5MZWZ0ID0gYCR7c3dpcGVMaXN0TWFyZ2luTGVmdCArIGFkZGl0aW9uYWxTd2lwZURpc3RhbmNlfXB4YDtcclxuICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgc2V0VGltZW91dCgoKSA9PiB7XHJcbiAgICAgICAgICAgICAgICBzd2lwZXJMaXN0LnN0eWxlLnRyYW5zaXRpb24gPSAnYWxsIDBzJztcclxuICAgICAgICAgICAgfSwgMjUwKTtcclxuICAgICAgICAgICAgXHJcbiAgICAgICAgICAgIHN3aXBlci5yZW1vdmVFdmVudExpc3RlbmVyKCdtb3VzZXVwJywgc3dpcGVNb3VzZU1vdmVPZmYpO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICBzd2lwZXIuYWRkRXZlbnRMaXN0ZW5lcignbW91c2Vkb3duJywgc3dpcGUpO1xyXG59KSgpO1xyXG5cclxuKCgpID0+IHtcclxuICBjb25zdCBtb2RhbFRyaWdnZXJzID0gZG9jdW1lbnQucXVlcnlTZWxlY3RvckFsbCgnKltkYXRhLW1vZGFsLXRhcmdldF0nKTtcclxuICBjb25zdCBjbG9zZU1vZGFsQnV0dG9ucyA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3JBbGwoJypbZGF0YS1tb2RhbC1jbG9zZV0nKTtcclxuICBsZXQgb3BlbmVkTW9kYWxJRDtcclxuXHJcbiAgY29uc3Qgb3Blbk1vZGFsV2luZG93ID0gKGV2dCkgPT4ge1xyXG4gICAgY29uc3QgdGFyZ2V0ID0gZXZ0LmN1cnJlbnRUYXJnZXQ7XHJcbiAgICBjb25zdCBtb2RhbElEID0gdGFyZ2V0LmRhdGFzZXQubW9kYWxUYXJnZXQ7XHJcbiAgICBjb25zdCB0YXJnZXRNb2RhbCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKG1vZGFsSUQpO1xyXG5cclxuICAgIChvcGVuZWRNb2RhbElEICE9PSB1bmRlZmluZWQpID8gY2xvc2VNb2RhbFdpbmRvdyhvcGVuZWRNb2RhbElEKSA6IG51bGw7XHJcblxyXG4gICAgKG1vZGFsSUQgPT09ICdzZXJ2aWNlLWV4YW1wbGUnKSA/IGNyZWF0ZUhlYWRlck9mU2VydmljZUV4YW1wbGVNb2RhbCh0YXJnZXQsIHRhcmdldE1vZGFsKSA6IG51bGw7XHJcblxyXG4gICAgb3BlbmVkTW9kYWxJRCA9IG1vZGFsSUQ7XHJcblxyXG4gICAgdGFyZ2V0TW9kYWwuY2xhc3NMaXN0LmFkZCgndmlzaWJsZScpO1xyXG4gICAgZG9jdW1lbnQucXVlcnlTZWxlY3RvcignYm9keScpLmNsYXNzTGlzdC5hZGQoJ2ZpeGVkJyk7XHJcblxyXG4gICAgd2luZG93LmFkZEV2ZW50TGlzdGVuZXIoJ2NsaWNrJywgY2xvc2VNb2RhbEJ5QmFja2dyb3VuZCk7XHJcbiAgICB3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcigna2V5ZG93bicsIGNsb3NlTW9kYWxCeUVzYyk7XHJcbiAgfTtcclxuXHJcbiAgY29uc3QgY2xvc2VNb2RhbEJ5RXNjID0gKGV2dCkgPT4ge1xyXG4gICAgaWYgKGV2dC5rZXkgPT09ICdFc2NhcGUnKSB7XHJcbiAgICAgIGNsb3NlTW9kYWxXaW5kb3cob3BlbmVkTW9kYWxJRClcclxuICAgIH1cclxuICB9O1xyXG5cclxuICBjb25zdCBjbG9zZU1vZGFsQnlCYWNrZ3JvdW5kID0gKGV2dCkgPT4ge1xyXG4gICAgaWYgKGV2dC50YXJnZXQuY2xhc3NMaXN0LmNvbnRhaW5zKCdtb2RhbF9fYmcnKSkge1xyXG4gICAgICBjbG9zZU1vZGFsV2luZG93KG9wZW5lZE1vZGFsSUQpXHJcbiAgICB9XHJcbiAgfTtcclxuXHJcbiAgY29uc3QgY2xvc2VNb2RhbEJ5QnV0dG9uID0gKGV2dCkgPT4gY2xvc2VNb2RhbFdpbmRvdyhldnQuY3VycmVudFRhcmdldC5kYXRhc2V0Lm1vZGFsQ2xvc2UpO1xyXG5cclxuICBjb25zdCBjbG9zZU1vZGFsV2luZG93ID0gKG1vZGFsSUQpID0+IHtcclxuICAgIGNvbnN0IHRhcmdldE1vZGFsID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQobW9kYWxJRCk7XHJcblxyXG4gICAgdGFyZ2V0TW9kYWwuY2xhc3NMaXN0LnJlbW92ZSgndmlzaWJsZScpO1xyXG4gICAgZG9jdW1lbnQucXVlcnlTZWxlY3RvcignYm9keScpLmNsYXNzTGlzdC5yZW1vdmUoJ2ZpeGVkJyk7XHJcblxyXG4gICAgd2luZG93LnJlbW92ZUV2ZW50TGlzdGVuZXIoJ2NsaWNrJywgY2xvc2VNb2RhbEJ5QmFja2dyb3VuZCk7XHJcbiAgICB3aW5kb3cucmVtb3ZlRXZlbnRMaXN0ZW5lcigna2V5ZG93bicsIGNsb3NlTW9kYWxCeUVzYyk7XHJcbiAgfTtcclxuXHJcbiAgY29uc3QgaW5pdGlhbGl6ZU1vZGFsVHJpZ2dlcnMgPSAoKSA9PiB7XHJcbiAgICBmb3IgKGNvbnN0IGJ1dHRvbiBvZiBtb2RhbFRyaWdnZXJzKSB7XHJcbiAgICAgIGJ1dHRvbi5hZGRFdmVudExpc3RlbmVyKCdjbGljaycsIG9wZW5Nb2RhbFdpbmRvdyk7XHJcbiAgICB9XHJcbiAgfTtcclxuXHJcbiAgY2xvc2VNb2RhbEJ1dHRvbnMuZm9yRWFjaChidXR0b24gPT4gYnV0dG9uLmFkZEV2ZW50TGlzdGVuZXIoJ2NsaWNrJywgY2xvc2VNb2RhbEJ5QnV0dG9uKSk7XHJcblxyXG4gIHdpbmRvdy5tb2RhbHMgPSB7XHJcbiAgICBvcGVuTW9kYWxXaW5kb3c6IG9wZW5Nb2RhbFdpbmRvdyxcclxuICAgIGNsb3NlTW9kYWxXaW5kb3c6IGNsb3NlTW9kYWxXaW5kb3csXHJcbiAgfTtcclxuXHJcbiAgZnVuY3Rpb24gY3JlYXRlSGVhZGVyT2ZTZXJ2aWNlRXhhbXBsZU1vZGFsKHRhcmdldCwgdGFyZ2V0TW9kYWwpIHtcclxuICAgIGNvbnN0XHJcbiAgICAgIHNlcnZpY2VUaXRsZSA9IHRhcmdldC5wYXJlbnRFbGVtZW50LnF1ZXJ5U2VsZWN0b3IoJy53aGF0LXlvdS1nZXRfX2l0ZW0tdGl0bGUnKS50ZXh0Q29udGVudC5yZXBsYWNlKC9cXHMrL2csJyAnKS50cmltKCksXHJcbiAgICAgIG1vZGFsVGl0bGUgPSB0YXJnZXRNb2RhbC5xdWVyeVNlbGVjdG9yKCcubW9kYWxfX3RpdGxlJyksXHJcbiAgICAgIHBhdGhUb0ltYWdlID0gdGFyZ2V0LmRhdGFzZXQubW9kYWxTZXJ2aWNlRXhhbXBsZUltYWdlLFxyXG4gICAgICBtb2RhbEltYWdlID0gdGFyZ2V0TW9kYWwucXVlcnlTZWxlY3RvcignLm1vZGFsX19pbWFnZScpO1xyXG4gICAgXHJcbiAgICBtb2RhbFRpdGxlLnRleHRDb250ZW50ID0gc2VydmljZVRpdGxlO1xyXG4gICAgbW9kYWxJbWFnZS5zcmMgPSBwYXRoVG9JbWFnZTtcclxuICB9XHJcblxyXG4gIGluaXRpYWxpemVNb2RhbFRyaWdnZXJzKCk7XHJcbn0pKCk7XHJcbigoKSA9PiB7XHJcbiAgY29uc3Qgc2Nyb2xsaW5nTGlua3MgPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yQWxsKCcqW2RhdGEtc2Nyb2xsLWxpbmtdJyk7XHJcblxyXG4gIGNvbnN0IHNjcm9sbFRvRWxlbWVudCA9IChldnQpID0+IHtcclxuICAgIGNvbnN0IHRhcmdldCA9IGV2dC50YXJnZXQ7XHJcbiAgICBjb25zdCBzY3JvbGxUbyA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKHRhcmdldC5kYXRhc2V0LnNjcm9sbExpbmspO1xyXG5cclxuICAgIGlmIChzY3JvbGxUbykge1xyXG4gICAgICBzY3JvbGxUby5zY3JvbGxJbnRvVmlldyh7XHJcbiAgICAgICAgYmVoYXZpb3I6ICdzbW9vdGgnXHJcbiAgICAgIH0pO1xyXG4gICAgfVxyXG4gIH07XHJcblxyXG4gIGlmKEJvb2xlYW4oc2Nyb2xsaW5nTGlua3MpKSB7XHJcbiAgICBzY3JvbGxpbmdMaW5rcy5mb3JFYWNoKGxpbmsgPT4gbGluay5hZGRFdmVudExpc3RlbmVyKCdjbGljaycsIHNjcm9sbFRvRWxlbWVudCkpO1xyXG4gIH1cclxufSkoKTtcclxuXHJcbm1lZGl1bVpvb20oJ1tkYXRhLXpvb21hYmxlXScpOyJdfQ==
